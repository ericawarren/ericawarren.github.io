# Erica Warren, PREDICT 455.55 Data Viz
# Assignment 4: Maps maps maps

setwd("C:/Users/Erica/Dropbox (Personal)/MSPA/455_Data-Visualization/Week8")
library(choroplethr)  # does what it sounds like. also includes Alaska and Hawaii!, 
# more info at https://github.com/trulia/choroplethr
library(choroplethrMaps)  # from the same source

# county-level unemployment data 
# from http://www.ers.usda.gov/data-products/county-level-data-sets/download-data.aspx
employment <- read.csv("Unemployment.csv", header = TRUE, stringsAsFactors = FALSE)
head(employment)

# pull out state data from full data
employment_state <- employment[grep(",", employment$Area_name, invert = TRUE), ]
head(employment_state)

# quick look at unemployment rate by state in 2013
unemp_rate_state_2013 <- subset(employment_state, select = c("Area_name", "Unemployment_rate_2013"))
head(unemp_rate_state_2013)

# rename columns and convert state names to lowercase to work with choroplethr
names(unemp_rate_state_2013) <- c("region", "value")
unemp_rate_state_2013$region <- tolower(unemp_rate_state_2013$region)

# remove duplicates
unemp_rate_state_2013 <- unique(unemp_rate_state_2013)
print(unemp_rate_state_2013)

(state_2013_map <- state_choropleth(unemp_rate_state_2013,
                                   title      = "2013 Unemployment Rate by State",
                                   legend     = "Unemployment Rate",
                                   num_colors = 1))

# let's make a function to do that for all years in the data set
unemployment <- function(year) {
  year <- as.character(year + 2005)
  column <- paste("Unemployment_rate", year, sep="_")
  # year_title <- paste(year, "Unemployment Rate by State", sep=" ")
  choro_df <- subset(employment_state, select = c("Area_name", column))
  choro_df <- unique(choro_df)
  
  # discretize continuous variable to make it easier to keep same scale across different years
  # needs to be labeled 'value' for choroplethr
  choro_df$value <- cut(choro_df[, column], 
                        breaks = c(2.5, 4.8, 7.1, 9.4, 11.7, 14.0), 
                        labels = c("[2.5, 4.8)", 
                                   "[4.8, 7.1)", 
                                   "[7.1, 9.4)", 
                                   "[9.4, 11.7)", 
                                   "[11.7, 14.0]"))

  # state names need to be called 'region' and lc for choroplethr
  names(choro_df)[1] <- "region"
  choro_df$region <- tolower(choro_df$region)
  head(choro_df)
  
  map <- state_choropleth(choro_df, 
                          legend = "Unemployment Rate", 
                          num_colors = 5)
  return(map)
}

# loop to make a map for each year in the data set
# and save to PDF
all_the_maps <- list()

for (i in 1:8)
{
  all_the_maps[[i]] <- unemployment(i)
  title = paste("Final_proj_test", i, ".svg", sep = "")
  svg(file = title, width = 11, height = 5)
  print(all_the_maps[[i]])
  dev.off()
}